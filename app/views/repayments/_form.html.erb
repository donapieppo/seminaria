<p class="info">
Per questo seminario è possibile fare richiesta di <strong>compenso e/o rimborso</strong> compilando i seguenti campi: 
</p>

<%= horizontal_form_for [@seminar, @repayment] do |repayment| %>  
  <%= repayment.dm_error_notification %>  

  <fieldset>
    <legend>Fondo</legend>
    <%= repayment.association :holder, collection: Fund.holders2, label_method: :cn_militar, include_blank: false %>
  </fieldset>

  <fieldset>
    <legend>Dati anagrafici <%= @seminar.speaker_with_title %></legend>
    <%= repayment.input :name %>
    <%= repayment.input :surname %>
    <%= repayment.input :birth_date %>
    <%= repayment.input :birth_place %>
    <%= repayment.input :birth_country, as: :string %>
  </fieldset>

  <fieldset>
    <legend>Ruolo <%= @seminar.speaker_with_title %></legend>
    <%= repayment.input :affiliation %>
    <%= repayment.input :role %> 
    <%= repayment.input :email %>
  </fieldset>

  <fieldset>
    <legend>Indirizzo di residenza <%= @seminar.speaker_with_title %></legend>
    <div class="input">
      <label>Residenza fiscale in Italia</label>
      <%= repayment.input_field :italy, label: false, boolean_style: :inline %>
    </div>
    <%= repayment.input :address %>
    <%= repayment.input :postalcode %>
    <%= repayment.input :city %>
    <div id="foreign_country">
      <%= repayment.input :country, as: :string, id: "foreign_country" %>
    </div>
  </fieldset>

  <!-- PAYMENT -->
  <fieldset>
    <legend>Compenso onnicomprensivo</legend>
    <div class="input">
      <p class="info">Il <strong>compenso massimo</strong> erogabile a conferenzieri con residenza fiscale in Italia è pari a 500 &euro; lordo percipiente (400 &euro; nette; 542,50 &euro; lordo ente).</p>
      <label>Richiedo compenso</label>
      <input type="checkbox" name="payment_bool" id="payment_bool" <%= 'checked="checked"' if @repayment.payment %>/>
    </div>
    <div id="payment_amount">
      <%= repayment.input :payment, as: :currency_float %>
      <%= repayment.input :gross, as: :radio_buttons, collection: [['Lordo ente', true], ['Compenso netto', false]], label: "", boolean_style: :inline %>  
      <div class=row">
        <div class="col-sm-9 col-sm-offset-3">
          <div id="payment_summary" %></div>
        </div>
      </div>  
      <%= repayment.input :cv, as: :file %>
      <div class=row">
        <div class="col-sm-9 col-sm-offset-3">
          <% can_delete = @repayment.documents.size > 1 %>  
          <% @repayment.documents.each do |doc| %>  
            allegato: <%= link_to_cv doc %> <%= link_to_delete document_path(doc) if can_delete %><br/>
          <% end %>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- REFUND -->
  <fieldset>
    <legend>Rimborsi</legend>
    <div class="input">
      <p class="info">Il relatore dovrà presentare <strong>nota spese</strong> con marca da bollo da 2 &euro; allegando i documenti originali comprovanti il sostenimento delle spese.<br/>
      Il rimborso spese è <strong>esente da ritenute</strong> solo se non è stata selezionata l'opzione per l'erogazione del compenso onnicomprensivo.</p>
      <label>Richiedo rimborso spese</label>
      <%= repayment.input_field :refund, boolean_style: :inline, id: 'refund_bool' %>
    </div>
    <div id="refund_details">
      <%= repayment.input :speaker_arrival,   as: :date_picker %>
      <%= repayment.input :speaker_departure, as: :date_picker %>
      <%= repayment.input :expected_refund,   as: :currency %>
    </div>
  </fieldset> 

  <p>
  <%= repayment.submit 'Salva', style: "margin-bottom: 0" %> -
  <% if ! @repayment.new_record? and current_user.is_admin? %>  
    <%= link_to 'stampa', repayment_path(@repayment), class: :button %> -
  <% end %>
  <%= link_to 'torna alla home page', root_path %>   
  </p>
<% end %>

<%= javascript_tag do %>  
  $(function(){
    $.fn.visibility_from = function (bool_check){
      var visible_element = this;
      visible_element.toggle($(bool_check).is(':checked'));
      $(bool_check).change(function(){
        visible_element.toggle($(bool_check).is(':checked'));
      });
      return visible_element;
    }

    $("#foreign_country").toggle(! $("#repayment_italy").is(':checked'));
    $("#repayment_italy").change(function(){
      $("#foreign_country").toggle(! $("#repayment_italy").is(':checked'));
    });
    
    $("#payment_amount").visibility_from("#payment_bool");
    $("#refund_details").visibility_from("#refund_bool");
  });
<% end %>

<%= javascript_tag do %>
  $(function() {
    function roundToTwo(num) {    
      return +(Math.round(num + "e+2")  + "e-2");
    };
    function show_lordo_percipiente() {
      italy   = $("#repayment_italy").is(':checked');
      gross   = $("#repayment_gross_true").is(':checked'); 
      payment = $("#repayment_payment").val();

      gross_result = 0;
      net_result   = 0;
      irap         = <%= Repayment::IRAP %>; 
      irpef        = italy ? <%= Repayment::IRPEF_ITALAN %> : <%= Repayment::IRPEF_FOREIGN %>; 
      adapt_net    = italy ? <%= Repayment::ADAPT_NET_ITALIAN_VALUE %> : <%= Repayment::ADAPT_NET_FOREIGN_VALUE %>;
      if (gross) {
        gross_result = payment;
        net_result   = payment * <%= Repayment::ADAPT_GROSS_VALUE %> * (1 - irpef);  
      } else {
        net_result   = payment;
        gross_result = payment * adapt_net * (1 + irap);
      }
      $("#payment_summary").html("<strong>Lordo ente:</strong> " + roundToTwo(gross_result) + " &euro;<br/>" +
                                 "<strong>Netto:</strong> " + roundToTwo(net_result) + " &euro;"); 
    };
    show_lordo_percipiente();
    $("#repayment_italy").change(function() { show_lordo_percipiente(); });
    $("#repayment_payment").change(function() { show_lordo_percipiente(); });
    $("div.repayment_gross").change(function() { show_lordo_percipiente(); });
  });
<% end %>

